name: Deploy to Production VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 91.98.117.169
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            echo 'SSH Connection successful!'
            whoami
            pwd
      
      - name: Deploy Application
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 91.98.117.169
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          command_timeout: 10m
          script: |
            cd /opt/devserver/projects/viktoria-wertheim
            echo 'Current directory:' && pwd
            echo 'Git pull...' && git pull origin main
            echo 'Docker build...' && docker-compose -f docker-compose.production.yml build
            echo 'Docker restart...' && docker-compose -f docker-compose.production.yml up -d
            echo 'Deployment complete!'
