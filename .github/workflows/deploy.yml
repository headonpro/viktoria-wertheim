name: Deploy to Production VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Manueller Trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 91.98.117.169
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo 'ğŸš€ Starting deployment...'
            cd /opt/devserver/projects/viktoria-wertheim
            
            # Backup current version
            echo 'ğŸ“¦ Creating backup...'
            mkdir -p ../backups
            cp -r . ../backups/viktoria-backup-$(date +%Y%m%d-%H%M%S)
            
            # Pull latest changes
            echo 'ğŸ“¥ Pulling latest changes from GitHub...'
            git pull origin main
            
            # Rebuild and restart containers
            echo 'ğŸ”¨ Building Docker image...'
            docker-compose -f docker-compose.production.yml build
            
            echo 'â™»ï¸ Restarting containers...'
            docker-compose -f docker-compose.production.yml down
            docker-compose -f docker-compose.production.yml up -d
            
            # Wait for startup
            echo 'â³ Waiting for services to start...'
            sleep 15
            
            # Check deployment
            echo 'ğŸ” Checking deployment status...'
            if curl -f http://localhost:8001 > /dev/null 2>&1; then
              echo 'âœ… Deployment successful!'
              echo 'Container status:'
              docker ps --format 'table {{.Names}}\t{{.Status}}' | grep viktoria
            else
              echo 'âŒ Health check failed but continuing...'
            fi
            
            echo 'ğŸ‰ Deployment complete!'
