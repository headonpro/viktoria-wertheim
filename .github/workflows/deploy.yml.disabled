name: Deploy to Production VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 91.98.117.169
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment..."
            cd /opt/devserver/projects/viktoria-wertheim
            
            # Show current status
            echo "ğŸ“ Current branch:"
            git branch --show-current
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # Build Docker image
            echo "ğŸ”¨ Building Docker image..."
            docker-compose -f docker-compose.production.yml build
            
            # Restart containers
            echo "â™»ï¸ Restarting containers..."
            docker-compose -f docker-compose.production.yml down
            docker-compose -f docker-compose.production.yml up -d
            
            # Wait for startup
            echo "â³ Waiting for services..."
            sleep 10
            
            # Check status
            echo "ğŸ“Š Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep viktoria || true
            
            echo "âœ… Deployment complete!"
